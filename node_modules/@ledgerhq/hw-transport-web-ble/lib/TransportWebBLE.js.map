{"version":3,"sources":["../src/TransportWebBLE.js"],"names":["requiresBluetooth","bluetooth","navigator","Error","availability","Observable","create","observer","onAvailabilityChanged","e","next","value","addEventListener","unsubscribed","getAvailability","then","available","removeEventListener","transportsCache","requestDeviceParam","filters","map","uuid","services","retrieveService","device","gatt","service","getPrimaryServices","infos","open","deviceOrId","needsReconnect","requestDevice","connected","connect","deviceModel","writeUuid","notifyUuid","writeC","notifyC","Promise","all","getCharacteristic","notifyObservable","pipe","toString","notif","subscribe","transport","BluetoothTransport","DisconnectedDevice","id","onDisconnect","console","log","notYetDisconnected","unsubscribe","emit","beforeMTUTime","Date","now","inferMTU","afterMTUTime","disconnect","s","setTimeout","Transport","listen","type","descriptor","complete","error","TransportOpenUserCancelled","message","constructor","writeCharacteristic","mtuSize","exchange","apdu","exchangeAtomicImpl","msgIn","data","receiveAPDU","write","toPromise","msgOut","String","buffer","writeValue","mtu","readUInt8","Buffer","from","setScrambleKey","close","exchangeBusyPromise","isSupported","resolve","observeAvailability","list"],"mappings":"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","sourcesContent":["// @flow\n/* eslint-disable prefer-template */\n\nimport Transport from \"@ledgerhq/hw-transport\";\nimport {\n  DisconnectedDevice,\n  TransportOpenUserCancelled,\n} from \"@ledgerhq/errors\";\nimport {\n  getBluetoothServiceUuids,\n  getInfosForServiceUuid,\n} from \"@ledgerhq/devices\";\nimport type { DeviceModel } from \"@ledgerhq/devices\";\nimport { sendAPDU } from \"@ledgerhq/devices/lib/ble/sendAPDU\";\nimport { receiveAPDU } from \"@ledgerhq/devices/lib/ble/receiveAPDU\";\nimport { log } from \"@ledgerhq/logs\";\nimport { Observable, defer, merge, from } from \"rxjs\";\nimport { share, ignoreElements, first, map, tap } from \"rxjs/operators\";\nimport type { Device, Characteristic } from \"./types\";\nimport { monitorCharacteristic } from \"./monitorCharacteristic\";\n\nconst requiresBluetooth = () => {\n  // $FlowFixMe\n  const { bluetooth } = navigator;\n  if (typeof bluetooth === \"undefined\") {\n    throw new Error(\"web bluetooth not supported\");\n  }\n  return bluetooth;\n};\n\nconst availability = (): Observable<boolean> =>\n  Observable.create((observer) => {\n    const bluetooth = requiresBluetooth();\n    const onAvailabilityChanged = (e) => {\n      observer.next(e.value);\n    };\n    bluetooth.addEventListener(\"availabilitychanged\", onAvailabilityChanged);\n    let unsubscribed = false;\n    bluetooth.getAvailability().then((available) => {\n      if (!unsubscribed) {\n        observer.next(available);\n      }\n    });\n    return () => {\n      unsubscribed = true;\n      bluetooth.removeEventListener(\n        \"availabilitychanged\",\n        onAvailabilityChanged\n      );\n    };\n  });\n\nconst transportsCache = {};\n\nconst requestDeviceParam = () => ({\n  filters: getBluetoothServiceUuids().map((uuid) => ({\n    services: [uuid],\n  })),\n});\n\nconst retrieveService = async (device) => {\n  if (!device.gatt) throw new Error(\"bluetooth gatt not found\");\n  const [service] = await device.gatt.getPrimaryServices();\n  if (!service) throw new Error(\"bluetooth service not found\");\n  const infos = getInfosForServiceUuid(service.uuid);\n  if (!infos) throw new Error(\"bluetooth service infos not found\");\n  return [service, infos];\n};\n\nasync function open(deviceOrId: Device | string, needsReconnect: boolean) {\n  let device;\n  if (typeof deviceOrId === \"string\") {\n    if (transportsCache[deviceOrId]) {\n      log(\"ble-verbose\", \"Transport in cache, using that.\");\n      return transportsCache[deviceOrId];\n    }\n\n    const bluetooth = requiresBluetooth();\n\n    // TODO instead we should \"query\" the device by its ID\n    device = await bluetooth.requestDevice(requestDeviceParam());\n  } else {\n    device = deviceOrId;\n  }\n\n  if (!device.gatt.connected) {\n    log(\"ble-verbose\", \"not connected. connecting...\");\n    await device.gatt.connect();\n  }\n\n  const [service, infos] = await retrieveService(device);\n  const { deviceModel, writeUuid, notifyUuid } = infos;\n  const [writeC, notifyC] = await Promise.all([\n    service.getCharacteristic(writeUuid),\n    service.getCharacteristic(notifyUuid),\n  ]);\n\n  const notifyObservable = monitorCharacteristic(notifyC).pipe(\n    tap((value) => {\n      log(\"ble-frame\", \"<= \" + value.toString(\"hex\"));\n    }),\n    share()\n  );\n\n  const notif = notifyObservable.subscribe();\n\n  const transport = new BluetoothTransport(\n    device,\n    writeC,\n    notifyObservable,\n    deviceModel\n  );\n\n  if (!device.gatt.connected) {\n    throw new DisconnectedDevice();\n  }\n\n  // eslint-disable-next-line require-atomic-updates\n  transportsCache[transport.id] = transport;\n  const onDisconnect = (e) => {\n    console.log(\"onDisconnect!\", e);\n    delete transportsCache[transport.id];\n    transport.notYetDisconnected = false;\n    notif.unsubscribe();\n    device.removeEventListener(\"gattserverdisconnected\", onDisconnect);\n    log(\"ble-verbose\", `BleTransport(${transport.id}) disconnected`);\n    transport.emit(\"disconnect\", e);\n  };\n  device.addEventListener(\"gattserverdisconnected\", onDisconnect);\n\n  let beforeMTUTime = Date.now();\n  try {\n    await transport.inferMTU();\n  } finally {\n    let afterMTUTime = Date.now();\n\n    // workaround for #279: we need to open() again if we come the first time here,\n    // to make sure we do a disconnect() after the first pairing time\n    // because of a firmware bug\n\n    if (afterMTUTime - beforeMTUTime < 1000) {\n      needsReconnect = false; // (optim) there is likely no new pairing done because mtu answer was fast.\n    }\n\n    if (needsReconnect) {\n      await device.gatt.disconnect();\n      // necessary time for the bonding workaround\n      await new Promise((s) => setTimeout(s, 4000));\n    }\n  }\n\n  if (needsReconnect) {\n    return open(device, false);\n  }\n\n  return transport;\n}\n\n/**\n * react-native bluetooth BLE implementation\n * @example\n * import BluetoothTransport from \"@ledgerhq/hw-transport-web-ble\";\n */\nexport default class BluetoothTransport extends Transport<Device | string> {\n  static isSupported = (): Promise<boolean> =>\n    Promise.resolve()\n      .then(requiresBluetooth)\n      .then(\n        () => true,\n        () => false\n      );\n\n  /**\n   * observe event with { available: bool, type: string }\n   * (available is generic, type is specific)\n   * an event is emit once and then each time it changes\n   */\n  static observeAvailability = (observer: *) =>\n    availability.subscribe(observer);\n\n  static list = (): * => Promise.resolve([]);\n\n  /**\n   * Scan for Ledger Bluetooth devices.\n   * On this web implementation, it only emits ONE device, the one that was selected in the UI (if any).\n   */\n  static listen(observer: *) {\n    log(\"ble-verbose\", \"listen...\");\n    let unsubscribed;\n\n    const bluetooth = requiresBluetooth();\n\n    bluetooth.requestDevice(requestDeviceParam()).then(\n      async (device) => {\n        if (!unsubscribed) {\n          observer.next({\n            type: \"add\",\n            descriptor: device,\n          });\n          observer.complete();\n        }\n      },\n      (error) => {\n        observer.error(new TransportOpenUserCancelled(error.message));\n      }\n    );\n    function unsubscribe() {\n      unsubscribed = true;\n    }\n    return { unsubscribe };\n  }\n\n  /**\n   * open a bluetooth device.\n   */\n  static async open(deviceOrId: Device | string) {\n    return open(deviceOrId, true);\n  }\n\n  /**\n   * globally disconnect a bluetooth device by its id.\n   */\n  static disconnect = async (id: *) => {\n    log(\"ble-verbose\", `user disconnect(${id})`);\n    const transport = transportsCache[id];\n    if (transport) {\n      transport.device.gatt.disconnect();\n    }\n  };\n\n  id: string;\n\n  device: Device;\n\n  mtuSize: number = 20;\n\n  writeCharacteristic: Characteristic;\n\n  notifyObservable: Observable<Buffer>;\n\n  notYetDisconnected = true;\n\n  deviceModel: DeviceModel;\n\n  constructor(\n    device: Device,\n    writeCharacteristic: Characteristic,\n    notifyObservable: Observable<*>,\n    deviceModel: DeviceModel\n  ) {\n    super();\n    this.id = device.id;\n    this.device = device;\n    this.writeCharacteristic = writeCharacteristic;\n    this.notifyObservable = notifyObservable;\n    this.deviceModel = deviceModel;\n\n    log(\"ble-verbose\", `BleTransport(${String(this.id)}) new instance`);\n  }\n\n  async inferMTU() {\n    let mtu = 23;\n\n    await this.exchangeAtomicImpl(async () => {\n      try {\n        mtu =\n          (await merge(\n            this.notifyObservable.pipe(\n              first((buffer) => buffer.readUInt8(0) === 0x08),\n              map((buffer) => buffer.readUInt8(5))\n            ),\n            defer(() => from(this.write(Buffer.from([0x08, 0, 0, 0, 0])))).pipe(\n              ignoreElements()\n            )\n          ).toPromise()) + 3;\n      } catch (e) {\n        log(\"ble-error\", \"inferMTU got \" + String(e));\n        this.device.gatt.disconnect();\n        throw e;\n      }\n    });\n\n    if (mtu > 23) {\n      const mtuSize = mtu - 3;\n      log(\n        \"ble-verbose\",\n        `BleTransport(${String(this.id)}) mtu set to ${String(mtuSize)}`\n      );\n      this.mtuSize = mtuSize;\n    }\n\n    return this.mtuSize;\n  }\n\n  /**\n   * Exchange with the device using APDU protocol.\n   * @param apdu\n   * @returns a promise of apdu response\n   */\n  exchange = (apdu: Buffer): Promise<Buffer> =>\n    this.exchangeAtomicImpl(async () => {\n      try {\n        const msgIn = apdu.toString(\"hex\");\n        log(\"apdu\", `=> ${msgIn}`);\n\n        const data = await merge(\n          this.notifyObservable.pipe(receiveAPDU),\n          sendAPDU(this.write, apdu, this.mtuSize)\n        ).toPromise();\n\n        const msgOut = data.toString(\"hex\");\n        log(\"apdu\", `<= ${msgOut}`);\n\n        return data;\n      } catch (e) {\n        log(\"ble-error\", \"exchange got \" + String(e));\n        if (this.notYetDisconnected) {\n          // in such case we will always disconnect because something is bad.\n          this.device.gatt.disconnect();\n        }\n        throw e;\n      }\n    });\n\n  setScrambleKey() {}\n\n  write = async (buffer: Buffer) => {\n    log(\"ble-frame\", \"=> \" + buffer.toString(\"hex\"));\n    await this.writeCharacteristic.writeValue(buffer);\n  };\n\n  async close() {\n    if (this.exchangeBusyPromise) {\n      await this.exchangeBusyPromise;\n    }\n  }\n}\n"],"file":"TransportWebBLE.js"}